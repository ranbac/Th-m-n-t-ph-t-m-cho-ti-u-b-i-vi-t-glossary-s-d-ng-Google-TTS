/**
 * =================================================================================
 * PHI√äN B·∫¢N HO√ÄN CH·ªàNH: B·∫¢O M·∫¨T, C√ì CACHE & T∆Ø∆†NG TH√çCH IOS
 * =================================================================================
 * Ch·ª©c nƒÉng: Th√™m n√∫t ph√°t √¢m cho ti√™u ƒë·ªÅ b√†i vi·∫øt 'glossary' s·ª≠ d·ª•ng Google TTS.
 * API Key ƒë∆∞·ª£c x·ª≠ l√Ω an to√†n ·ªü ph√≠a server.
 * File √¢m thanh ƒë∆∞·ª£c cache l·∫°i ƒë·ªÉ ti·∫øt ki·ªám chi ph√≠ v√† tƒÉng t·ªëc ƒë·ªô.
 */

// -----------------------------------------------------------------------------
// PH·∫¶N 1: TH√äM N√öT B·∫§M V√ÄO N·ªòI DUNG B√ÄI VI·∫æT
// -----------------------------------------------------------------------------
function them_nut_doc_tieu_de_glossary_v2($content) {
    // Ch·ªâ ho·∫°t ƒë·ªông tr√™n trang chi ti·∫øt c·ªßa post type 'glossary'
    if ( is_singular('glossary') ) {
        $tieu_de = get_the_title();
        // N√∫t b·∫•m gi·ªù ƒë√¢y s·∫Ω ch·ª©a Post ID ƒë·ªÉ g·ª≠i ƒëi qua AJAX
        $nut_bam_html = '
            <p>
                <strong>Ph√°t √¢m</strong> 
                <button id="google-tts-button" 
                        data-post-id="' . get_the_ID() . '" 
                        style="cursor: pointer; border: none; background: none; font-size: 1.5em; vertical-align: middle; padding: 0;">
                        üîä
                </button>
                <span id="google-tts-status" style="font-size: 0.8em; margin-left: 8px;"></span>
            </p>
            <hr>';
        return $nut_bam_html . $content;
    }
    return $content;
}
add_filter('the_content', 'them_nut_doc_tieu_de_glossary_v2');


// -----------------------------------------------------------------------------
// PH·∫¶N 2: TH√äM JAVASCRIPT V√Ä TRUY·ªÄN D·ªÆ LI·ªÜU AN TO√ÄN T·ª™ PHP -> JS
// -----------------------------------------------------------------------------
function them_script_cho_nut_doc_tieu_de_v2() {
    if ( is_singular('glossary') ) {
        // ƒêƒÉng k√Ω file script (t·∫°m th·ªùi vi·∫øt inline b√™n d∆∞·ªõi)
        wp_register_script('google-tts-script', false);
        wp_enqueue_script('google-tts-script');

        // Truy·ªÅn d·ªØ li·ªáu t·ª´ PHP sang JavaScript m·ªôt c√°ch an to√†n
        // Bao g·ªìm URL ƒë·ªÉ g·ªçi AJAX v√† m·ªôt nonce ƒë·ªÉ b·∫£o m·∫≠t
        wp_localize_script('google-tts-script', 'tts_ajax_object', [
            'ajax_url' => admin_url('admin-ajax.php'),
            'nonce'    => wp_create_nonce('google_tts_nonce')
        ]);

        ?>
        <script type="text/javascript" id="google-tts-script-inline">
            document.addEventListener('DOMContentLoaded', function() {
                const playButton = document.getElementById('google-tts-button');
                const statusLabel = document.getElementById('google-tts-status');
                const audioPlayer = new Audio();

                if (playButton) {
                    playButton.addEventListener('click', async function() {
                        const postId = this.getAttribute('data-post-id');
                        
                        // M·ªü kh√≥a audio context cho iOS
                        audioPlayer.play().catch(e => {});

                        statusLabel.textContent = 'ƒêang t·∫£i...';
                        playButton.disabled = true;

                        const formData = new FormData();
                        formData.append('action', 'get_google_tts_audio'); // T√™n action hook
                        formData.append('post_id', postId);
                        formData.append('nonce', tts_ajax_object.nonce); // G·ª≠i nonce b·∫£o m·∫≠t

                        try {
                            const response = await fetch(tts_ajax_object.ajax_url, {
                                method: 'POST',
                                body: formData
                            });
                            
                            const data = await response.json();

                            if (data.success) {
                                audioPlayer.src = data.data.audioUrl;
                                audioPlayer.play();
                                statusLabel.textContent = '';
                            } else {
                                throw new Error(data.data.message || 'C√≥ l·ªói x·∫£y ra.');
                            }

                        } catch (error) {
                            console.error('L·ªói khi x·ª≠ l√Ω TTS:', error);
                            statusLabel.textContent = error.message;
                        } finally {
                            playButton.disabled = false;
                        }
                    });
                }
            });
        </script>
        <?php
    }
}
add_action('wp_footer', 'them_script_cho_nut_doc_tieu_de_v2');


// -----------------------------------------------------------------------------
// PH·∫¶N 3: X·ª¨ L√ù Y√äU C·∫¶U AJAX ·ªû PH√çA SERVER
// -----------------------------------------------------------------------------
function xu_ly_tts_ajax_v2() {
    // 1. Ki·ªÉm tra nonce b·∫£o m·∫≠t
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'google_tts_nonce')) {
        wp_send_json_error(['message' => 'Y√™u c·∫ßu kh√¥ng h·ª£p l·ªá!'], 403);
        return;
    }

    // 2. L·∫•y post ID v√† ti√™u ƒë·ªÅ
    if (!isset($_POST['post_id']) || !($post_id = intval($_POST['post_id']))) {
        wp_send_json_error(['message' => 'Thi·∫øu Post ID.'], 400);
        return;
    }
    $text_to_read = get_the_title($post_id);
    if (empty($text_to_read)) {
        wp_send_json_error(['message' => 'Kh√¥ng t√¨m th·∫•y ti√™u ƒë·ªÅ.'], 404);
        return;
    }

    // 3. Thi·∫øt l·∫≠p h·ªá th·ªëng Cache
    $upload_dir = wp_upload_dir();
    $cache_dir_path = $upload_dir['basedir'] . '/google-tts-cache';
    $cache_dir_url = $upload_dir['baseurl'] . '/google-tts-cache';
    
    // T·∫°o th∆∞ m·ª•c cache n·∫øu ch∆∞a t·ªìn t·∫°i
    if (!file_exists($cache_dir_path)) {
        wp_mkdir_p($cache_dir_path);
    }

    $file_name = md5($text_to_read) . '.mp3';
    $file_path = $cache_dir_path . '/' . $file_name;
    $file_url = $cache_dir_url . '/' . $file_name;

    // 4. KI·ªÇM TRA CACHE: N·∫øu file ƒë√£ t·ªìn t·∫°i, tr·∫£ v·ªÅ lu√¥n
    if (file_exists($file_path)) {
        wp_send_json_success(['audioUrl' => $file_url]);
        return;
    }

    // 5. G·ªåI API GOOGLE: N·∫øu file ch∆∞a c√≥ trong cache
    // !!! QUAN TR·ªåNG: H√£y thay API Key c·ªßa b·∫°n v√†o ƒë√¢y.
    // ƒê·ªÉ b·∫£o m·∫≠t h∆°n n·ªØa, b·∫°n n√™n ƒë·ªãnh nghƒ©a key n√†y trong file wp-config.php
    $api_key = 'AIzaSyAbkWfXQvw3B6xJR9h_AI3FVo0MbiWmxRo'; 
    $api_url = 'https://texttospeech.googleapis.com/v1/text:synthesize?key=' . $api_key;
    
    $request_body = [
        'input' => ['text' => $text_to_read],
        'voice' => ['languageCode' => 'cmn-CN', 'name' => 'cmn-CN-Standard-A'],
        'audioConfig' => ['audioEncoding' => 'MP3', 'speakingRate' => 0.8]
    ];
    
    $response = wp_remote_post($api_url, [
        'headers' => ['Content-Type' => 'application/json; charset=utf-8'],
        'body' => json_encode($request_body),
        'method' => 'POST',
        'data_format' => 'body',
        'timeout' => 15,
    ]);

    if (is_wp_error($response)) {
        wp_send_json_error(['message' => 'L·ªói k·∫øt n·ªëi ƒë·∫øn Google API.'], 500);
        return;
    }

    $response_body = json_decode(wp_remote_retrieve_body($response), true);

    if (isset($response_body['audioContent'])) {
        // 6. L∆ØU V√ÄO CACHE V√Ä TR·∫¢ V·ªÄ K·∫æT QU·∫¢
        $audio_content = base64_decode($response_body['audioContent']);
        file_put_contents($file_path, $audio_content);
        wp_send_json_success(['audioUrl' => $file_url]);
    } else {
        $error_message = isset($response_body['error']['message']) ? $response_body['error']['message'] : 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ Google API.';
        wp_send_json_error(['message' => $error_message], 500);
    }
}
// Hook action cho c·∫£ ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p v√† ch∆∞a ƒëƒÉng nh·∫≠p
add_action('wp_ajax_get_google_tts_audio', 'xu_ly_tts_ajax_v2');
add_action('wp_ajax_nopriv_get_google_tts_audio', 'xu_ly_tts_ajax_v2');

